#!/usr/bin/env python
"""
################################################################################
MercuPy Wrap
Jorge Zuluaga (C) 2011
################################################################################
"""
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#IMPORT UTILITIES
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
from mercupy import *

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#LOAD SYSTEM CONFIGURATION FILE
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
inifile="system.config"
state=loadconf(inifile)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#DATA FILE HEADER
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
helems=\
    state.POSITION_ELEMENTS.split()+\
    state.ORBITAL_ELEMENTS.split()+\
    state.PHYSICAL_ELEMENTS.split()
NELS=len(helems)

header="%-12s "%("#1:t")
i=2
for el in helems:
    header+="%-12s "%("%d:%s"%(i,el))
    i+=1

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#CHECK IF A PREVIOUS PHASE WAS RAN
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if os.path.lexists(OUTDIR+"/phase"):
    phase,time=System("cat output/phase",out=True).split()
    endtime=float(time)
else:
    endtime=0

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#LOAD THE OUTPUT DATA FROM FILES
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
ShowObjects=[]
BID=dict()
cbody=state.BODIES[0]
for body in state.BODIES:
    if not body['ShowObject']:continue
    if body["ShowObject"] and body["Type"]!=CENTRAL:
        print "Getting data for body %s..."%body["Code"]
        io=0
        jo=1
        for ext in ["pos","orb","phy"]:
            print "\tRetrieving information from '%s' file..."%ext
            bname=body["Code"]
            fname=bname+"."+ext
            ftmp="tmp/"+fname+".tmp"
            fstore="tmp/%s.dat"%bname
            fplain="%s/%s.dat"%(OUTDIR,bname)
            
            #CONVERT FILE TO PLAIN FORMAT
            System("sed -e 's/\\*/0/gi' %s/%s | grep -v '^$' | grep -v '%s' | grep -v 'Time' > %s"%(OUTDIR,fname,bname,ftmp))
            
            #READ DATA
            data=np.loadtxt(ftmp)
            times=data[:,0]+endtime
            elements=data[:,1:]

            #SAVE RESULT
            ntimes=times.shape[0]
	    nels=elements.shape[1]
            if io==0:
                datsel=np.zeros((ntimes,NELS+1))

            for i in range(0,ntimes):
                if io==0: 
                    datsel[i,0]=times[i]
                for j in range(jo,jo+nels):
                    datsel[i,j]=elements[i,j-jo]

            jo+=nels
            io+=1
                    
        np.savetxt(fstore,datsel,fmt=('%-12.5e'))
        System("(echo '%s';cat %s)>%s"%(header,fstore,fplain))
